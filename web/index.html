<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RSAcrack Coil</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b0f16; --panel:#101827cc; --panel-solid:#101827;
    --text:#e6eefc; --muted:#a9b7d9; --accent:#5eead4; --accent-2:#93c5fd;
    --danger:#fb7185; --warn:#fbbf24; --ok:#34d399; --chip:#111827; --chip-border:#243145;
    --card-radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; }
  .wrap{ display:grid; grid-template-columns: 360px 1fr; height:100%; }
  @media (max-width: 900px){ .wrap{ grid-template-columns: 1fr; grid-template-rows: auto 1fr; } }

  .panel{
    padding:16px 16px 10px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00)) , var(--panel);
    backdrop-filter: blur(8px);
    border:1px solid #1f2a44;
    border-radius:0 0 var(--card-radius) var(--card-radius);
    box-shadow: var(--shadow);
  }
  .header{
    display:flex; align-items:center; gap:10px; padding:16px;
    background:var(--panel-solid); border-bottom:1px solid #1f2a44;
  }
  .brand{ font-weight:700; letter-spacing:.2px; }
  .badge{
    padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #2a3654; color:#c9d5ff; background:#0e1627;
  }
  .controls{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .controls .wide{ grid-column: 1 / -1; }
  label{ font-size:12px; color:var(--muted); margin:6px 0 4px; display:block; }
  input{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid #2a3654; background:#0e1627; color:var(--text);
    outline:none; transition: border-color .15s, box-shadow .15s;
  }
  input:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.25); }
  .btn{
    appearance:none; border:0; background:linear-gradient(135deg, #2563eb, #22d3ee);
    color:#061020; font-weight:700; padding:12px 14px; border-radius:12px; cursor:pointer; box-shadow: var(--shadow);
  }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .btn-secondary{ background:#142036; color:#bcd3ff; border:1px solid #2a3654; }

  .jsoncard{
    margin-top:12px; background:#0d1626; border:1px solid #20304d; border-radius:12px; padding:10px; max-height:40vh; overflow:auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#cfe3ff;
  }
  .row{ display:flex; gap:8px; align-items:center; }
  .row > .grow{ flex:1; }
  .chips{ display:flex; gap:6px; flex-wrap:wrap; }
  .chip{ padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chip-border); color:#cfe3ff; font-size:12px; }

  .toast{
    position:fixed; right:14px; bottom:14px; background:#0e1828; border:1px solid #2a3654; border-radius:10px; padding:10px 12px; box-shadow: var(--shadow); display:none;
  }
  .toast.show{ display:block; animation:fade .25s ease-out; }
  @keyframes fade{ from{opacity:0; transform: translateY(6px);} to{opacity:1; transform:none;} }

  canvas{ display:block; width:100%; height:100%; }
  .stage{ position:relative; }
  .spinner{
    position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
  }
  .dot{
    width:10px; height:10px; border-radius:50%; background:var(--accent);
    box-shadow:0 0 16px var(--accent);
    animation:b 1s infinite alternate;
  }
  @keyframes b{ from{ transform:scale(1); opacity:.6 } to{ transform:scale(1.7); opacity:1 } }

  .status{ display:flex; gap:8px; align-items:center; margin:10px 0 12px; }
  .status .pill{ padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #2a3654; }
  .pill.ok{ background:#06241c; color:#7ef0c9; border-color:#1f5d50; }
  .pill.warn{ background:#2a2307; color:#ffd776; border-color:#5b4a13; }
  .pill.err{ background:#2a0d12; color:#ff97a6; border-color:#5c1c27; }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: UI -->
    <aside>
      <div class="header">
        <div class="brand">RSAcrack Coil</div>
        <span id="version" class="badge">v1</span>
        <span id="status-pill" class="pill warn" style="margin-left:auto;">idle</span>
      </div>
      <div class="panel">
        <div class="controls">
          <div class="wide">
            <label>n</label>
            <input id="n" type="number" value="91" min="2" step="1" />
          </div>
          <div>
            <label>r0</label>
            <input id="r0" type="number" value="1.0" step="0.01" />
          </div>
          <div>
            <label>alpha</label>
            <input id="alpha" type="number" value="0.0125" step="0.001" />
          </div>
          <div>
            <label>beta</label>
            <input id="beta" type="number" value="0.005" step="0.001" />
          </div>
          <div>
            <label>L</label>
            <input id="L" type="number" value="360" step="1" />
          </div>
          <div class="wide row">
            <button id="go" class="btn grow">Classify + Render</button>
            <button id="copy" class="btn-secondary">Copy JSON</button>
          </div>
        </div>

        <div class="status">
          <div id="class-pill" class="pill warn">pending</div>
          <div class="chips" id="chips"></div>
        </div>

        <div id="out" class="jsoncard">{ "hint": "Click ‘Classify + Render’ or press Enter." }</div>
      </div>
    </aside>

    <!-- RIGHT: 3D -->
    <section class="stage">
      <canvas id="c"></canvas>
      <div id="spinner" class="spinner" hidden>
        <div class="dot"></div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";

const els = {
  n: q('#n'), r0: q('#r0'), alpha: q('#alpha'), beta: q('#beta'), L: q('#L'),
  go: q('#go'), out: q('#out'), chips: q('#chips'), status: q('#status-pill'),
  classPill: q('#class-pill'), spinner: q('#spinner'), copy: q('#copy'), toast: q('#toast')
};

function q(s, r=document){ return r.querySelector(s); }
function toast(msg, kind="ok"){
  els.toast.textContent = msg;
  els.toast.className = "toast show";
  setTimeout(()=> els.toast.className = "toast", 1600);
}
function setClassPill(cls){
  const map = { prime:"ok", semiprime:"ok", other:"warn", "not valid (≤1)":"err", unknown:"warn" };
  const kind = map[cls] || "warn";
  els.classPill.className = `pill ${kind}`;
  els.classPill.textContent = cls;
}
function setBusy(b){
  els.spinner.hidden = !b;
  els.status.textContent = b ? "working…" : "ready";
  els.status.className = `pill ${b?"warn":"ok"}`;
}
function chips(primes){
  els.chips.innerHTML = "";
  if (!primes) return;
  for (const p of primes){
    const d = document.createElement('div');
    d.className = 'chip'; d.textContent = `prime: ${p}`;
    els.chips.appendChild(d);
  }
}

// THREE setup
const canvas = q('#c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0f16);
const camera = new THREE.PerspectiveCamera(60, 2, 0.01, 8000);
camera.position.set(0, 0, 22);

const light1 = new THREE.DirectionalLight(0xffffff, 1.1);
light1.position.set(5,10,8); scene.add(light1);
scene.add(new THREE.AmbientLight(0xffffff, 0.25));

let points = null;

function makeCoilPoints(N, r0, alpha, beta, L){
  const aN = new Float32Array(N); for (let i=0;i<N;i++) aN[i] = i+1;
  const geom = new THREE.BufferGeometry();
  geom.setAttribute("aN", new THREE.BufferAttribute(aN, 1));
  const vsh = `
    precision highp float;
    attribute float aN;
    uniform float r0, alpha, beta, L;
    varying float vN;
    void main(){
      float n = aN;
      float r = r0 + alpha * n;
      float th = 6.28318530718 * n / L;
      vec3 pos = vec3(r*cos(th), r*sin(th), beta*n);
      vec4 mv = modelViewMatrix * vec4(pos,1.0);
      gl_Position = projectionMatrix * mv;
      gl_PointSize = clamp(3.0 / -mv.z * 250.0, 1.0, 6.0);
      vN = n;
    }`;
  const fsh = `
    precision highp float;
    varying float vN;
    uniform float p, q, n;
    void main(){
      vec3 col = vec3(0.22,0.32,0.78);
      if (abs(vN-1.0)<0.5) col = vec3(0.95,0.9,0.2);
      if (abs(vN-p)<0.5) col = vec3(0.2,0.95,0.65);
      if (abs(vN-q)<0.5) col = vec3(0.95,0.4,0.35);
      if (abs(vN-n)<0.5) col = vec3(0.98,0.7,0.25);
      gl_FragColor = vec4(col, 1.0);
    }`;
  const mat = new THREE.ShaderMaterial({
    vertexShader:vsh, fragmentShader:fsh,
    uniforms:{
      r0:{value:r0}, alpha:{value:alpha}, beta:{value:beta}, L:{value:L},
      p:{value:0}, q:{value:0}, n:{value:0}
    }
  });
  const pts = new THREE.Points(geom, mat);
  scene.add(pts);
  return pts;
}

function fit(){
  const w = canvas.clientWidth || canvas.parentElement.clientWidth;
  const h = canvas.clientHeight || canvas.parentElement.clientHeight;
  if (canvas.width !== w || canvas.height !== h){
    renderer.setSize(w, h, false);
    camera.aspect = w/h; camera.updateProjectionMatrix();
  }
}
function renderLoop(ts=0){
  fit();
  scene.rotation.z += 0.0012;
  renderer.render(scene, camera);
  requestAnimationFrame(renderLoop);
}
renderLoop();

// gentle orbit
let angle = 0;
setInterval(()=>{ angle += 0.012; camera.position.x = 22*Math.sin(angle)*0.3; camera.lookAt(0,0,0); }, 16);

async function classifyAndRender(){
  try{
    setBusy(true);
    const n = +els.n.value|0;
    const r0 = +els.r0.value, alpha = +els.alpha.value, beta = +els.beta.value, L = +els.L.value;
    const url = `/api/classify?n=${n}&r0=${r0}&alpha=${alpha}&beta=${beta}&L=${L}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const data = await res.json();

    els.out.textContent = JSON.stringify(data, null, 2);
    setClassPill(data.class);
    chips(data.primes);

    if (points) scene.remove(points);
    points = makeCoilPoints(Math.min(n, 25000), r0, alpha, beta, L);
    points.material.uniforms.n.value = n;
    if (data.class === "semiprime"){
      points.material.uniforms.p.value = data.primes[0];
      points.material.uniforms.q.value = data.primes[1];
    }else{
      points.material.uniforms.p.value = 0;
      points.material.uniforms.q.value = 0;
    }
    toast("Updated.");
  }catch(err){
    toast("Error: " + err.message, "err");
  }finally{
    setBusy(false);
  }
}

els.go.addEventListener('click', classifyAndRender);
document.addEventListener('keydown', (e)=>{ if(e.key==="Enter") classifyAndRender(); });
els.copy.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(els.out.textContent); toast("JSON copied"); }
  catch{ toast("Copy failed","err"); }
});

// kickoff
classifyAndRender();
</script>
</body>
</html>
